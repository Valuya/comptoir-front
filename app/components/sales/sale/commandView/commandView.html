<div class="commandView" *ng-if="aSale != null">

    <header class="coloredHeader">
        <h1 [class.dirty]="aSale.dirty">
            <span>Vente</span>
            <span class="saleRef" [hidden]="aSale.saleId == null">
                #{{ aSale.saleId }}
            </span>
        </h1>
        <span class="busy">
            <span class="valignAnchor"></span>
            <img src="res/img/spinner-2-white.gif"
                 [hidden]="!aSale.dirty"/>
        </span>

        <div class="actions" *ng-if="aSale.sale != null"
             [hidden]="aSale.items.length <= 0">
            <div class="action reduction"
                 [hidden]="validated"
                 (^click)="editingSaleDiscount = true"
                 [class.editing]="editingSaleDiscount"
                 [class.has-reduction]="aSale.discountPercentage > 0">
                <span [hidden]="editingSaleDiscount || aSale.discountPercentage > 0">
                    Réduction
                </span>
                <span [hidden]="editingSaleDiscount || aSale.discountPercentage == null || aSale.discountPercentage <= 0">
                    -{{ aSale.discountPercentage | number:'.0' }} %
                </span>
                <span *ng-if="editingSaleDiscount">
                    <input #reduction [(value)]="aSale.discountPercentage"
                           (keyup)="onSaleDiscountKeyEvent($event)"
                           (blur)="applySaleDicountPercentage()"
                           (input)="onSalePercentageChanged($event)"
                           type="number" min="0.01" step="0.01"
                           size="2" autofocusselect/>
                    %
                </span>
            </div>
            <div class="action validate" (click)="doValidate()" [hidden]="validated">Encaisser</div>
            <div class="action back" (click)="doUnvalidate()" [hidden]="!validated">Retour</div>
        </div>
    </header>

    <table class="dataTable" [hidden]="aSale.items ==  null">
        <thead>
        <tr>
            <th>Ref</th>
            <th>Nom</th>
            <th class="amount number">Quantité</th>
            <th class="price number">Prix</th>
            <th class="actions" [hidden]="validated"></th>
        </tr>
        </thead>

        <tbody>
        <tr *ng-for="#saleItem of aSale.items"
            class="saleItem" [class.dirty]="saleItem.dirty">

            <td class="ref">
                <span *ng-if="saleItem.item != null" [hidden]="saleItem.item == null">
                    {{ saleItem.item.reference }}
                </span>
            </td>
            <td class="name" *ng-if="saleItem.item != null" >
                {{ saleItem.item.name[language] }}
            </td>
            <td class="amount number">
                <a class="quantityLink" (^click)="doEditItemAmount(saleItem)"
                   *ng-if="saleItem.item != null"
                   [class.editing]="editingAmountItem == saleItem"
                   [class.unneeded]="saleItem.quantity <= 1 || editingAmountItem == saleItem"
                   [class.nolink]="validated"
                   [class.actionLink]="!validated">
                        <span class="count">
                            {{ saleItem.quantity}} x
                        </span>
                        <span class="price" >
                            {{ saleItem.item.vatExclusive | currency:'EUR':true:'.2-2'  }}
                        </span>
                </a>
                <span class="editAmount" *ng-if="editingAmountItem == saleItem">
                    <input #amount [value]="saleItem.quantity"
                           (keyup)="onItemAmountKeyEvent($event)"
                           (input)="onItemAmountChanged($event)"
                           (blur)="applyItemAmount()"
                           type="number" min="1"
                           size="4" autofocusselect/>
                </span>
            </td>
            <td class="price number">
                <a class="reduction green"
                   [class.unneeded]="saleItem.discountPercentage == null || saleItem.discountPercentage <= 0 || editingDiscountSaleItem == saleItem"
                   [class.nolink]="validated"
                   [class.actionLink]="!validated"
                   (^click)="doEditItemDiscount(saleItem)">
                    -{{ ( saleItem.discountPercentage) | number:'.0-0' }}%
                </a>
                <span class="setReduction" *ng-if="editingDiscountSaleItem == saleItem">
                    <input #reduction [(value)]="saleItem.discountPercentage"
                           (keyup)="onItemDiscountKeyEvent($event)"
                           (input)="onItemDiscountPercentageChanged($event)"
                           (blur)="applyItemDicountPercentage()"
                           type="number" min="0.1" step="0.1"
                           size="2" autofocusselect/>
                    %
                </span>
                <span>{{  saleItem.vatExclusive | currency:'EUR':true:'.2-2' }}</span>
            </td>
            <td class="actions" [hidden]="validated">
                <a class="actionIcon remove" (^click)="doRemoveItem(saleItem)">
                    <i class="fi-x red"></i>
                </a>
                <a class="actionIcon setReductionLink" (^click)="doEditItemDiscount(saleItem)"
                   [hidden]="saleItem.discountPercentage > 0 || editingDiscountSaleItem == saleItem">
                    <span class="green" style="font-weight: bold;">%</span>
                </a>
            </td>
        </tr>

        </tbody>
        <tfoot *ng-if="aSale.sale != null" [hidden]="aSale.items.length <= 0">
        <tr [hidden]="aSale.discountRate == null || aSale.discountRate <= 0"
            class="details">
            <th colspan="3" class="reduction">
                Réduction {{ (aSale.discountRate * 100) | number:'.0-0' }}%
            </th>
            <th class="reduction number">-{{ aSale.discountAmount | currency:'EUR':true:'.2-2'}}</th>
        </tr>
        <tr class="details">
            <th colspan="3">Total HTVA</th>
            <th class="number">{{ aSale.vatExclusive | currency:'EUR':true:'.2-2'}}</th>
        </tr>
        <tr class="details">
            <th colspan="3">TVA</th>
            <th class="number">{{ aSale.vatAmount | currency:'EUR':true:'.2-2'}}</th>
        </tr>

        <tr>
            <th colspan="3" class="total">Total</th>
            <th class="total price number">
                {{ (aSale.vatExclusive + aSale.sale.vatAmount) | currency:'EUR':true:'.2-2' }}
            </th>
        </tr>
        </tfoot>
    </table>
    <div class="newItem" [hidden]="validated">
        <h2>Ajouter un produit</h2>

        <form (ng-submit)="doAddCustomItem()">
            <input #name placeholder="Nom" class="name"
                   [value]="toAddItem.name"
                   (input)="toAddItem.name = name.value">
            <input #amount placeholder="Quantité" class="amount"
                   type="number" min="1" step="1"
                   [value]="toAddItem.amount"
                   (input)="setToAddItemAmount(amount.value)">
            <span>
            <input #price placeholder="Prix unitaire" class="price number"
                   type="number" min="0.01" step="0.01"
                   [value]="toAddItem.price | number:'.2-2'"
                   (input)="setToAddItemPrice($event)">€
            </span>
            <span>
            <input #vat placeholder="TVA" class="vat number"
                   type="number" min="0.01" step="0.01"
                   [value]="toAddItem.vat | number:'.2-2'"
                   (input)="setToAddItemVat($event)">%
            </span>
            <button type='submit' [disabled]="!isItemToAddValid()">Ajouter</button>
        </form>
    </div>


</div>
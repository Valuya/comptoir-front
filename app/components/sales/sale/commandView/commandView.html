<div class="commandView" *ng-if="aSale != null">

    <header class="coloredHeader">
        <h1 [class.dirty]="aSale.dirty">
            <span>Vente</span>
            <span class="saleRef" [hidden]="aSale.saleId == null">
                #{{ aSale.saleId }}
            </span>
        </h1>
        <span class="busy">
            <span class="valignAnchor"></span>
            <img src="res/img/spinner-2-white.gif"
                 [hidden]="!aSale.dirty"/>
        </span>

        <div class="actions" *ng-if="aSale.sale != null"
             [hidden]="aSale.items.length <= 0">
            <div class="action reduction"
                 [hidden]="validated"
                 (^click)="doEditSaleDiscount()"
                 [class.editing]="editingSaleDiscount"
                 [class.has-reduction]="aSale.discountPercentage > 0">
                <span [hidden]="editingSaleDiscount || aSale.discountPercentage > 0">
                    Réduction
                </span>
                <span [hidden]="editingSaleDiscount || aSale.discountPercentage == null || aSale.discountPercentage <= 0">
                    -{{ aSale.discountPercentage | number:'.0' }} %
                </span>
                <span *ng-if="editingSaleDiscount" class="editDiscount">
                    <input #discount
                           [value]="aSale.discountPercentage"
                           [validator]="validateDiscount"
                           (fast-change)="onSaleDiscountChange($event)"
                           type="number" min="0" max="100" step="1"
                           size="2" fast-input/>
                    %
                    <span class="editActions">
                        <i class="fi-check green" (^click)="discount.doValidate()"></i>
                        <i class="fi-x red" (^click)="discount.doCancel()"></i>
                    </span>
                </span>
            </div>
            <div class="action validate" (click)="doValidate()" [hidden]="validated">Encaisser</div>
            <div class="action back" (click)="doUnvalidate()" [hidden]="!validated">Retour</div>
        </div>
    </header>

    <table class="dataTable" [hidden]="aSale.items ==  null">
        <thead>
        <tr>
            <th>Ref</th>
            <th>Nom</th>
            <th class="quantity number">Quantité</th>
            <th class="price number">Prix</th>
            <th class="actions" [hidden]="validated"></th>
        </tr>
        </thead>

        <tbody>
        <tr *ng-for="#saleItem of aSale.items"
            #row
            class="saleItem" [class.dirty]="saleItem.dirty">

            <td class="ref">
                <span *ng-if="saleItem.item != null">
                    {{ saleItem.item.reference }}
                </span>
            </td>
            <td class="name" *ng-if="saleItem.item != null">
                <div class="name">
                    {{ saleItem.item.name[language] }}
                </div>
                <div class="comment">
                    <a class="commentLink"
                       (^click)="doEditItemComment(saleItem)"
                       [class.actionLink]="!validated"
                       [class.editing]="editingItem == saleItem && editingItemComment"
                       [class.unneeded]="!hasComment(saleItem)"
                       [class.nolink]="validated">
                        {{ saleItem.comment[language] }}
                    </a>
                    <span *ng-if="editingItem == saleItem && editingItemComment">
                        <input #activeInput
                               [value]="saleItem.comment[language]"
                               (fast-change)="onItemCommentChange($event)"
                               type="text"
                               size="14" fast-input/>
                    </span>
                </div>
            </td>
            <td class="quantity number">
                <span class="quantityAmountLinks"
                      [class.editing]="(editingItemQuantity || editingItemPrice) && (editingItem == saleItem)"
                      [class.unneeded]="saleItem.quantity <= 1"
                      [class.nolink]="validated">
                    <a class="quantityLink"
                       (^click)="doEditItemQuantity(saleItem)"
                       [class.actionLink]="!validated">
                            <span class="count">
                                {{ saleItem.quantity}} x
                            </span>
                    </a>
                    <a class="priceLink"
                       (^click)="doEditItemPrice(saleItem)"
                       [class.actionLink]="!validated">
                            <span class="price">
                                {{ saleItem.vatExclusive | currency:'EUR':true:'.2-2'  }}
                            </span>
                    </a>
                </span>
                <span class="editQuantity"
                      *ng-if="editingItemQuantity && editingItem == saleItem">
                    <input #activeInput
                           [value]="saleItem.quantity"
                           [validator]="validateQuantity"
                           (fast-change)="onItemQuantityChange($event)"
                           type="number" min="1" step="1"
                           size="4" fast-input >
                </span>
                <span class="editPrice"
                      *ng-if="editingItemPrice && editingItem == saleItem">
                    <input #activeInput
                           [value]="saleItem.vatExclusive"
                           [validator]="validatePrice"
                           (fast-change)="onItemPriceChange($event)"
                           type="number" min="0.01" step="0.01"
                           size="6" fast-input > €
                </span>
            </td>
            <td class="price number">
                <a class="reduction green"
                   [class.unneeded]="saleItem.discountPercentage == null || saleItem.discountPercentage <= 0 || (editingItem == saleItem && editingItemDiscount)"
                   [class.nolink]="validated"
                   [class.actionLink]="!validated"
                   (^click)="doEditItemDiscount(saleItem)">
                    -{{ ( saleItem.discountPercentage) | number:'.0' }}%
                </a>
                <span class="setReduction"
                      *ng-if="editingItem == saleItem && editingItemDiscount">
                    <input #activeInput
                           [value]="saleItem.discountPercentage"
                           [validator]="validateDiscount"
                           (fast-change)="onItemDiscountChange($event)"
                           type="number" min="1" max="100" step="1"
                           size="2" fast-input/>
                    %
                </span>
                <span>{{ saleItem.total | currency:'EUR':true:'.2-2' }}</span>
            </td>
            <td class="actions" [hidden]="validated">
                <a class="actionIcon noBlur validate"
                   (^click)="doValidateInput(row)"
                   [hidden]="editingItem != saleItem">
                    <i class="fi-check green"></i>
                </a>
                <a class="actionIcon noBlur validate"
                   (^click)="doCancelInput(row)"
                   [hidden]="editingItem != saleItem">
                    <i class="fi-x red"></i>
                </a>
                <a class="actionIcon remove"
                   [hidden]="editingItem != null"
                   (^click)="doRemoveItem(saleItem)">
                    <i class="fi-minus red"></i>
                </a>
                <a class="actionIcon setReductionLink"
                   (^click)="doEditItemDiscount(saleItem)"
                   [hidden]="saleItem.discountPercentage > 0 || editingItem != null">
                    <span class="green" style="font-weight: bold;">%</span>
                </a>
                <a class="actionIcon commentLink"
                   (^click)="doEditItemComment(saleItem)"
                   [hidden]="hasComment(saleItem) || editingItem != null">
                    <i class="fi-comment"></i>
                </a>
            </td>
        </tr>

        </tbody>
        <tfoot *ng-if="aSale.sale != null" [hidden]="aSale.items.length <= 0">
        <tr [hidden]="aSale.discountPercentage == null || aSale.discountPercentage <= 0"
            class="details">
            <th colspan="3" class="saleFooter reduction">
                Réduction {{ (aSale.discountPercentage) | number:'.0' }}%
            </th>
            <th class="saleFooter reduction number">
                -{{ aSale.discountAmount | currency:'EUR':true:'.2-2'}}
            </th>
        </tr>
        <tr class="details">
            <th colspan="3" class="saleFooter">Total HTVA</th>
            <th class="saleFooter number">{{ aSale.vatExclusive | currency:'EUR':true:'.2-2'}}</th>
        </tr>
        <tr class="details">
            <th colspan="3" class="saleFooter">TVA</th>
            <th class="number saleFooter">{{ aSale.vatAmount | currency:'EUR':true:'.2-2'}}</th>
        </tr>

        <tr>
            <th colspan="3" class="total saleFooter">Total</th>
            <th class="total price number saleFooter">
                {{ aSale.total | currency:'EUR':true:'.2-2' }}
            </th>
        </tr>
        </tfoot>
    </table>


</div>
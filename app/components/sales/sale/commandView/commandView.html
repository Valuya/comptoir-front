<div class="commandView" *ng-if="sale != null">
    <header class="coloredHeader"
            [class.inactive]="noInput">
        <h1>
            <span>Vente</span>
            <span class="saleRef" [hidden]="sale.id == null">
                #{{ sale.id}}
            </span>
        </h1>
        <span class="busy">
            <span class="valignAnchor"></span>
            <img src="res/img/spinner-2-white.gif"
                 [hidden]="saleItemsRequest.request == null"/>
        </span>

        <div class="actions"
             [hidden]="noInput || saleItemsResult?.list?.length < 1">
            <div class="action reduction"
                 [hidden]="validated"
                 (^click)="doEditSaleDiscount()"
                 [class.editing]="editingSaleDiscount"
                 [class.has-reduction]="sale.discountRatio > 0">
                <span [hidden]="editingSaleDiscount || sale.discountRatio > 0">
                    Réduction
                </span>
                <span [hidden]="editingSaleDiscount || sale.discountRatio == null || sale.discountRatio <= 0">
                    -{{ (sale.discountRatio * 100) | number:'.0' }} %
                </span>
                <span *ng-if="editingSaleDiscount" class="editDiscount">
                    <input #discount
                           [validator]="validateDiscount"
                           (fast-change)="onSaleDiscountChange($event)"
                           type="number" min="0" max="100" step="1"
                           size="2" fast-input/>
                    %
                    <span class="editActions">
                        <i class="fi-check green" (^click)="discount.doValidate()"></i>
                        <i class="fi-x red" (^click)="discount.doCancel()"></i>
                    </span>
                </span>
            </div>
            <div class="action validate" (click)="doValidate()" [hidden]="validated">Encaisser</div>
            <div class="action back" (click)="doUnvalidate()" [hidden]="!validated">Retour</div>
        </div>
    </header>

    <table class="dataTable" *ng-if="saleItemsResult != null"
           [hidden]="saleItemsResult.count == 0">
        <thead>
        <tr>
            <th>Ref</th>
            <th>Nom</th>
            <th class="quantity number">Quantité</th>
            <th class="price number">Prix</th>
            <th class="actions" [hidden]="validated"></th>
        </tr>
        </thead>

        <tbody>
        <tr *ng-for="#saleItem of saleItemsResult.list"
            #row
            class="saleItem" [class.dirty]="saleItem.dirty">

            <td class="ref">
                <span *ng-if="saleItem.itemVariant != null">
                    {{ saleItem.itemVariant?.variantReference }}
                </span>
            </td>
            <td class="name">
                <div class="name" *ng-if="saleItem.itemVariant?.item != null">
                    {{ saleItem.itemVariant?.item?.name[locale] }}
                </div>
                <div class="comment">
                    <a class="commentLink"
                       (^click)="doEditItemComment(saleItem)"
                       [class.actionLink]="!validated"
                       [class.editing]="editingItem == saleItem && editingItemComment"
                       [class.unneeded]="!hasComment(saleItem)"
                       [class.nolink]="validated">
                        {{ saleItem.comment[locale] }}
                    </a>
                    <span *ng-if="editingItem == saleItem && editingItemComment">
                        <input [(ng-model)]="editingValue"
                               (fast-change)="onItemCommentChange($event)"
                               type="text"
                               size="14" fast-input/>
                    </span>
                </div>
            </td>
            <td class="quantity number">
                <span class="quantityAmountLinks"
                      [class.editing]="(editingItemQuantity || editingItemPrice) && (editingItem == saleItem)"
                      [class.unneeded]="saleItem.quantity <= 1"
                      [class.nolink]="validated">
                    <a class="quantityLink"
                       (^click)="doEditItemQuantity(saleItem)"
                       [class.actionLink]="!validated">
                            <span class="count">
                                {{ saleItem.quantity}} x
                            </span>
                    </a>
                    <a class="priceLink"
                       (^click)="doEditItemPrice(saleItem)"
                       [class.actionLink]="!validated">
                            <span class="price">
                                {{ saleItem.vatExclusive | currency:'EUR':true:'.2-2'  }}
                            </span>
                    </a>
                </span>
                <span class="editQuantity"
                      *ng-if="editingItemQuantity && editingItem == saleItem">
                    <input [validator]="validateQuantity"
                           (fast-change)="onItemQuantityChange($event)"
                           type="number" min="1" step="1"
                           size="4" fast-input>
                </span>
                <span class="editPrice"
                      *ng-if="editingItemPrice && editingItem == saleItem">
                    <input [validator]="validatePrice"
                           (fast-change)="onItemPriceChange($event)"
                           type="number" min="0.01" step="0.01"
                           size="6" fast-input> €
                </span>
            </td>
            <td class="price number">
                <a class="reduction green"
                   [class.unneeded]="saleItem.discountRatio == null || saleItem.discountRatio <= 0 || (editingItem == saleItem && editingItemDiscount)"
                   [class.nolink]="validated"
                   [class.actionLink]="!validated"
                   (^click)="doEditItemDiscount(saleItem)">
                    -{{ ( saleItem.discountRatio * 100) | number:'.0' }}%
                </a>
                <span class="setReduction"
                      *ng-if="editingItem == saleItem && editingItemDiscount">
                    <input [validator]="validateDiscount"
                           (fast-change)="onItemDiscountChange($event)"
                           type="number" min="1" max="100" step="1"
                           size="2" fast-input/>
                    %
                </span>
                <span>{{ saleItem.total | currency:'EUR':true:'.2-2' }}</span>
            </td>
            <td class="actions" [hidden]="validated">
                <a class="actionIcon noBlur validate"
                   (^click)="doValidateInput(row)"
                   [hidden]="editingItem != saleItem">
                    <i class="fi-check green"></i>
                </a>
                <a class="actionIcon noBlur validate"
                   (^click)="doCancelInput(row)"
                   [hidden]="editingItem != saleItem">
                    <i class="fi-x red"></i>
                </a>
                <a class="actionIcon remove"
                   [hidden]="editingItem != null"
                   (^click)="doRemoveItem(saleItem)">
                    <i class="fi-minus red"></i>
                </a>
                <a class="actionIcon setReductionLink"
                   (^click)="doEditItemDiscount(saleItem)"
                   [hidden]="saleItem.discountPercentage > 0 || editingItem != null">
                    <span class="green" style="font-weight: bold;">%</span>
                </a>
                <a class="actionIcon commentLink"
                   (^click)="doEditItemComment(saleItem)"
                   [hidden]="hasComment(saleItem) || editingItem != null">
                    <i class="fi-comment"></i>
                </a>
            </td>
        </tr>

        </tbody>
        <tfoot [hidden]="saleItemsResult?.list?.length <= 0">
        <tr [hidden]="sale.discountRatio == null"
            class="details">
            <th colspan="3" class="saleFooter reduction">
                Réduction {{ (sale.discountRatio * 100) | number:'.0' }}%
            </th>
            <th class="saleFooter reduction number">
                -{{ sale.discountAmount | currency:'EUR':true:'.2-2'}}
            </th>
        </tr>
        <tr class="details">
            <th colspan="3" class="saleFooter">Total HTVA</th>
            <th class="saleFooter number">{{ sale.vatExclusiveAmount | currency:'EUR':true:'.2-2'}}</th>
        </tr>
        <tr class="details">
            <th colspan="3" class="saleFooter">TVA</th>
            <th class="number saleFooter">{{ sale.vatAmount | currency:'EUR':true:'.2-2'}}</th>
        </tr>

        <tr>
            <th colspan="3" class="total saleFooter">Total</th>
            <th class="total price number saleFooter">
                {{ (sale.vatExclusiveAmount + sale.vatAmount) | currency:'EUR':true:'.2-2' }}
            </th>
        </tr>
        </tfoot>
    </table>


</div>
<div class="commandView">
    <header class="coloredHeader">
        <div class="commandNav" (^click)="switchCommandNavVisibility()"
             [class.disabled]="validated || (command.items.length == 0 && commandService.activeCommands.length == 1)">
            <span class="valignAnchor"></span>

            <h1>Commande {{ command.id }}
            <span [hidden]="validated || (command.items.length == 0 && commandService.activeCommands.length == 1)">
                ▼
            </span>
            </h1>

            <div class="commandsMenu" [hidden]="!commandNavVisible">
                <div class="command" *ng-for="#activeCommand of commandService.activeCommands; #index=index"
                     [hidden]="activeCommand == command"
                     (^click)="switchToCommand(activeCommand)">
                    <span class="name">Commande {{ activeCommand.id }}</span>
                    <span class="reduction" [hidden]="activeCommand.globalReduction == null">-{{ activeCommand.globalReduction }}%</span>
                    <span class="total" [hidden]="activeCommand.totalPrice <= 0">{{ activeCommand.totalPrice | currency:'EUR':true:'.2-2' }}</span>
                </div>
                <div class="links">
                    <a (click)="switchToNewCommand()" [hidden]="command.items.length == 0">Nouvelle commande</a>
                    <a (click)="cancelCommand()" [hidden]="command.items.length == 0  ">Annuler cette commande</a>
                </div>
            </div>
        </div>

        <div class="actions" *ng-if="command.getItems().length > 0">

            <div class="action reduction" *ng-if="validated == false"
                 (^click)="editingGlobalReduction = true"
                 [class.editing]="editingGlobalReduction"
                 [class.has-reduction]="command.globalReduction > 0">
                <span [hidden]="editingGlobalReduction || command.globalReduction > 0">
                    Réduction
                </span>
                <span *ng-if="editingGlobalReduction == false && command.globalReduction > 0">
                    -{{ command.globalReduction}} %
                </span>
                <span *ng-if="editingGlobalReduction">
                    <input #reduction [value]="command.globalReduction"
                           (keyup)="applyGlobalReduction($event)"
                           (blur)="cancelGlobalReduction()"
                           type="number" min="0.01" step="0.01"
                           size="2" autoFocus/>
                    %
                </span>
            </div>
            <div class="action cashIn" (click)="doValidate()" *ng-if="validated == false">Encaisser</div>
            <div class="action cashIn" (click)="doUnvalidate()" *ng-if="validated == true">Retour</div>
        </div>
    </header>
    <table class="dataTable">
        <thead *ng-if="command.getItems().length > 0">
        <tr>
            <th>Ref</th>
            <th>Nom</th>
            <th class="amount number">Quantité</th>
            <th class="price number">Prix</th>
            <th class="actions" [hidden]="validated"></th>
        </tr>
        </thead>
        <tbody>
        <tr *ng-for="#commandItem of command.items"
            class="commandItem">

            <td class="ref">
                <span [hidden]="commandItem.item.reference == null">
                    {{ commandItem.item.reference }}
                </span>
            </td>
            <td class="name">
                {{ commandItem.item.name.localeTextMap[locale.isoCode] }}
            </td>
            <td class="amount number">
                <a class="quantityLink" (^click)="doEditItemAmount(commandItem)"
                   [class.editing]="editingAmountItem == commandItem"
                   [class.unneeded]="commandItem.amount <= 1 || editingAmountItem == commandItem"
                   [class.nolink]="validated"
                        [class.actionLink]="!validated">
                        <span class="count">
                            {{ commandItem.amount}} x
                        </span>
                        <span class="price">
                            {{ commandItem.item.currentPrice.vatExclusive | currency:'EUR':true:'.2-2'  }}
                        </span>
                </a>
                <span class="editAmount" *ng-if="editingAmountItem == commandItem">
                    <input #amount [value]="commandItem.amount"
                           (keyup)="applyItemAmount($event)"
                           (blur)="cancelItemAmount()"
                           type="number" min="1"
                           size="4" autoFocus/>
                </span>
            </td>
            <td class="price number">
                <a class="reduction green"
                   [class.unneeded]="commandItem.reduction <= 0 || editingReductionItem == commandItem"
                   [class.nolink]="validated"
                   [class.actionLink]="!validated"
                   (^click)="doEditItemReduction(commandItem)">
                    -{{commandItem.reduction}}%
                </a>
                <span class="setReduction" *ng-if="editingReductionItem == commandItem">
                    <input #reduction [value]="commandItem.reduction"
                           (keyup)="onEditItemReductionKeyUp($event)"
                           (blur)="doCancelItemReduction()"
                           type="number" min="0.1" step="0.1"
                           size="2" autoFocus/>
                    %
                </span>
                <span>{{ commandItem.price | currency:'EUR':true:'.2-2' }}</span>
            </td>
            <td class="actions" [hidden]="validated">
                <a class="actionIcon remove" (^click)="doClearItem(commandItem)">
                    <i class="fi-x red"></i>
                </a>
                <a class="actionIcon setReductionLink" (^click)="doEditItemReduction(commandItem)"
                   [hidden]="commandItem.reduction > 0 || editingReductionItem == commandItem">
                    <span class="green" style="font-weight: bold;">%</span>
                </a>
            </td>
        </tr>

        </tbody>
        <tfoot *ng-if="command.getItems().length > 0">
        <tr *ng-if="command.globalReduction > 0" class="details">
            <th colspan="3" class="reduction">
                Réduction {{command.globalReduction}}%
            </th>
            <th class="reduction number">-{{ command.reductionAmount | currency:'EUR':true:'.2-2'}}</th>
        </tr>
        <tr class="details">
            <th colspan="3">Total HTVA</th>
            <th class="number">{{ command.vatExclusiveAmount | currency:'EUR':true:'.2-2'}}</th>
        </tr>
        <tr class="details">
            <th colspan="3">TVA</th>
            <th class="number">{{ command.vatAmount | currency:'EUR':true:'.2-2'}}</th>
        </tr>

        <tr>
            <th colspan="3" class="total">Total</th>
            <th class="total price number">{{ command.totalPrice | currency:'EUR':true:'.2-2'}}</th>
        </tr>
        </tfoot>
    </table>
    <div class="newItem" *ng-if="validated == false">
        <h2>Ajouter un produit</h2>

        <form>
            <input #name placeholder="Nom" class="name"
                   [value]="toAddItem.name" (keyup)="toAddItem.name = name.value">
            <input #amount placeholder="Quantité" class="amount"
                   type="number" min="1" step="1"
                   [value]="toAddItem.amount"
                   (keyup)="setToAddItemAmount(amount.value)"
                   (change)="setToAddItemAmount(amount.value)">
            <input #price placeholder="Prix unitaire" class="price number"
                   type="number" min="0.01" step="0.01"
                   [value]="toAddItem.price | number:'.2-2'"
                   (keyup)="handleToAdditemPriceKeyUp($event)"
                   (change)="setToAddItemPrice($event)">
            <button (click)="doAddCustomItem()" [disabled]="!isItemToAddValid()">Ajouter</button>
        </form>
    </div>


</div>